{"version":3,"sources":["../src/satori.ts"],"sourcesContent":["// satori.ts\r\nimport WebSocket from 'ws';\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\n/**\r\n * Represents a field-value condition for filtering operations.\r\n * @example\r\n * { field: \"email\", value: \"test@example.com\" }\r\n */\r\nexport interface FieldCondition {\r\n  field: string;\r\n  value: string;\r\n}\r\n\r\n/**\r\n * Payload for SET operation.\r\n * @example\r\n * {\r\n *   key: \"user:123\",\r\n *   data: { name: \"John\" },\r\n *   type: \"user\",\r\n *   expires: true,\r\n *   expiration_time: 60000\r\n * }\r\n */\r\nexport interface SetPayload {\r\n  key?: string;\r\n  vertices?: string[];\r\n  data?: Record<string, any>;\r\n  type?: string;\r\n  expires?: boolean;\r\n  expiration_time?: number;\r\n  field_array?: FieldCondition[];\r\n  one?: boolean;\r\n}\r\n\r\n/**\r\n * Payload for GET operation.\r\n * @example\r\n * { key: \"user:123\" }\r\n */\r\nexport interface GetPayload {\r\n  key?: string;\r\n  encryption_key?: string;\r\n  field_array?: FieldCondition[];\r\n  one?: boolean;\r\n}\r\n\r\n/**\r\n * Payload for PUT operation.\r\n * @example\r\n * {\r\n *   key: \"user:123\",\r\n *   replace_field: \"name\",\r\n *   replace_value: \"Jane\"\r\n * }\r\n */\r\nexport interface PutPayload {\r\n  key?: string;\r\n  replace_field: string;\r\n  replace_value: string;\r\n  encryption_key?: string;\r\n  field_array?: FieldCondition[];\r\n  one?: boolean;\r\n  type?: string;\r\n}\r\n\r\n/**\r\n * Payload for DELETE operation.\r\n * @example\r\n * { key: \"user:123\" }\r\n */\r\nexport interface DeletePayload {\r\n  key?: string;\r\n  field_array?: FieldCondition[];\r\n  one?: boolean;\r\n  type?: string;\r\n}\r\n\r\n/**\r\n * Payload for SET_VERTEX operation.\r\n * @example\r\n * {\r\n *   key: \"user:123\",\r\n *   vertex: \"friend:456\",\r\n *   encryption_key: \"secret\"\r\n *   relation: \"friend\"\r\n * }\r\n */\r\nexport interface SetVertexPayload {\r\n  key: string;\r\n  vertex: string | string[];\r\n  relation?: string;\r\n  encryption_key: string;\r\n}\r\n\r\n/**\r\n * Payload for GET_VERTEX operation.\r\n * @example\r\n * {\r\n *   key: \"user:123\",\r\n *   encryption_key: \"secret\"\r\n * }\r\n */\r\nexport interface GetVertexPayload {\r\n  key: string;\r\n  encryption_key: string;\r\n  relation?: string;\r\n}\r\n\r\n/**\r\n * Payload for DELETE_VERTEX operation.\r\n * @example\r\n * {\r\n *   key: \"user:123\",\r\n *   vertex: \"friend:456\"\r\n * }\r\n */\r\nexport interface DeleteVertexPayload {\r\n  key: string;\r\n  vertex: string;\r\n  encryption_key?: string;\r\n}\r\n\r\n/**\r\n * Payload for DFS traversal.\r\n * @example\r\n * {\r\n *   node: \"user:123\",\r\n *   encryption_key: \"secret\"\r\n * }\r\n */\r\nexport interface DfsPayload {\r\n  node: string;\r\n  encryption_key: string;\r\n  relation?: string;\r\n}\r\n\r\n/**\r\n * Payload for ENCRYPT operation.\r\n * @example\r\n * {\r\n *   key: \"user:123\",\r\n *   encryption_key: \"secret\"\r\n * }\r\n */\r\nexport interface EncryptPayload {\r\n  key: string;\r\n  encryption_key: string;\r\n}\r\n\r\n/**\r\n * Payload for DECRYPT operation.\r\n * @example\r\n * {\r\n *   key: \"user:123\",\r\n *   encryption_key: \"secret\"\r\n * }\r\n */\r\nexport interface DecryptPayload {\r\n  key: string;\r\n  encryption_key: string;\r\n}\r\n\r\n/**\r\n * Payload with type only.\r\n * @example\r\n * { type: \"user\" }\r\n */\r\nexport interface TypeOnlyPayload {\r\n  type: string;\r\n}\r\n\r\n/**\r\n * Payload for reference operations.\r\n * @example\r\n * {\r\n *   key: \"user:123\",\r\n *   ref: \"profile:123\"\r\n * }\r\n */\r\nexport interface RefPayload {\r\n  key: string;\r\n  ref?: string;\r\n  encryption_key?: string;\r\n}\r\n\r\ninterface CommandPayload {\r\n  command: string;\r\n  [key: string]: any;\r\n}\r\n\r\n/**\r\n * Satori WebSocket client class for interacting with the database.\r\n * @example\r\n * const client = new Satori({ username: 'user', password: 'pass', host: 'ws://localhost:8000' });\r\n * await client.connect();\r\n */\r\nexport class Satori {\r\n  private username: string;\r\n  private password: string;\r\n  private host: string;\r\n  private ws: WebSocket | null = null;\r\n  private pending = new Map<string, (value: any) => void>();\r\n  private subscriptions = new Map<string, (data: any) => void>();\r\n\r\n  /**\r\n   * Creates an instance of Satori.\r\n   */\r\n  constructor({ username, password, host }: { username: string; password: string; host: string }) {\r\n    this.username = username;\r\n    this.password = password;\r\n    this.host = host;\r\n  }\r\n\r\n  /**\r\n   * Connects to the WebSocket server.\r\n   */\r\n  async connect(): Promise<void> {\r\n    this.ws = new WebSocket(this.host);\r\n\r\n    this.ws.on('message', (data) => {\r\n      const msg = JSON.parse(data.toString());\r\n\r\n      if (msg.type === 'notification' && msg.key && this.subscriptions.has(msg.key)) {\r\n        this.subscriptions.get(msg.key)?.(msg.data);\r\n        return;\r\n      }\r\n\r\n      if (msg.id && this.pending.has(msg.id)) {\r\n        this.pending.get(msg.id)?.(msg);\r\n        this.pending.delete(msg.id);\r\n      }\r\n    });\r\n\r\n    return new Promise((resolve, reject) => {\r\n      if (!this.ws) return reject();\r\n      this.ws.on('open', resolve);\r\n      this.ws.on('error', reject);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Sends a command with payload to the server.\r\n   */\r\n  private send(commandPayload: CommandPayload): Promise<any> {\r\n    return new Promise((resolve) => {\r\n      const id = uuidv4();\r\n      const msg = { id, ...commandPayload };\r\n      this.pending.set(id, resolve);\r\n      this.ws?.send(JSON.stringify(msg));\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Performs a SET operation.\r\n   */\r\n  async set(payload: SetPayload) {\r\n    const command = 'SET';\r\n    return this.send({ command, ...payload });\r\n  }\r\n\r\n  /**\r\n   * Performs a GET operation.\r\n   */\r\n  async get(payload: GetPayload) {\r\n    const command ='GET';\r\n    return this.send({ command, ...payload });\r\n  }\r\n\r\n  /**\r\n   * Performs a PUT operation.\r\n   */\r\n  async put(payload: PutPayload) {\r\n    const command = 'PUT';\r\n    return this.send({ command, ...payload });\r\n  }\r\n\r\n  /**\r\n   * Performs a DELETE operation.\r\n   */\r\n  async delete(payload: DeletePayload) {\r\n    const command = 'DELETE';\r\n    return this.send({ command, ...payload });\r\n  }\r\n\r\n  /**\r\n   * Performs a SET_VERTEX operation.\r\n   */\r\n  async setVertex(payload: SetVertexPayload) {\r\n    return this.send({ command: 'SET_VERTEX', ...payload });\r\n  }\r\n\r\n  /**\r\n   * Performs a GET_VERTEX operation.\r\n   */\r\n  async getVertex(payload: GetVertexPayload) {\r\n    return this.send({ command: 'GET_VERTEX', ...payload });\r\n  }\r\n\r\n  /**\r\n   * Performs a DELETE_VERTEX operation.\r\n   */\r\n  async deleteVertex(payload: DeleteVertexPayload) {\r\n    return this.send({ command: 'DELETE_VERTEX', ...payload });\r\n  }\r\n\r\n  /**\r\n   * Performs a DFS traversal.\r\n   */\r\n  async dfs(payload: DfsPayload) {\r\n    return this.send({ command: 'DFS', ...payload });\r\n  }\r\n\r\n  /**\r\n   * Encrypts data.\r\n   */\r\n  async encrypt(payload: EncryptPayload) {\r\n    return this.send({ command: 'ENCRYPT', ...payload });\r\n  }\r\n\r\n  /**\r\n   * Decrypts data.\r\n   */\r\n  async decrypt(payload: DecryptPayload) {\r\n    return this.send({ command: 'DECRYPT', ...payload });\r\n  }\r\n\r\n\r\n  /**\r\n   * Sets a reference to another object.\r\n   */\r\n  async setRef(payload: RefPayload) {\r\n    return this.send({ command: 'SET_REF', ...payload });\r\n  }\r\n\r\n  /**\r\n   * Retrieves all references for a key.\r\n   */\r\n  async getRefs(payload: RefPayload) {\r\n    return this.send({ command: 'GET_REFS', ...payload });\r\n  }\r\n\r\n  /**\r\n   * Deletes all references for a key.\r\n   */\r\n  async deleteRefs(payload: RefPayload) {\r\n    return this.send({ command: 'DELETE_REFS', ...payload });\r\n  }\r\n\r\n  /**\r\n   * Deletes a specific reference.\r\n   */\r\n  async deleteRef(payload: RefPayload) {\r\n    return this.send({ command: 'DELETE_REF', ...payload });\r\n  }\r\n\r\n  /**\r\n   * Subscribe to real-time changes of an object by key.\r\n   * @param key - The key of the object to subscribe to\r\n   * @param callback - Function called with updated data on each change\r\n   * @example\r\n   * client.notify('user:123', data => console.log('Updated:', data));\r\n   */\r\n  notify(key: string, callback: (data: any) => void) {\r\n    this.subscriptions.set(key, callback);\r\n    this.ws?.send(JSON.stringify({ command: 'NOTIFY', key }));\r\n  }\r\n\r\n  /**\r\n   * Unsubscribe from real-time notifications for a key.\r\n   * @param key - The key to unsubscribe\r\n   * @example\r\n   * client.unnotify('user:123');\r\n   */\r\n  unnotify(key: string) {\r\n    this.subscriptions.delete(key);\r\n    this.ws?.send(JSON.stringify({ command: 'UNNOTIFY', key }));\r\n  }\r\n}\r\n"],"mappings":"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","names":[]}