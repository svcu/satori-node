{"version":3,"sources":["../src/core/transport-node.ts","../src/core/transport-browser.ts","../src/index.ts","../src/core/SatoriClient.ts","../src/react/useSatori.ts","../src/schema.ts"],"sourcesContent":["// src/core/transport-node.ts\r\nimport WS from \"ws\";\r\nimport { ISocket } from \"./ISocket\";\r\n\r\nexport function createNodeSocket(url: string): ISocket {\r\n  const socket = new WS(url);\r\n\r\n  return {\r\n    get readyState() {\r\n      return socket.readyState;\r\n    },\r\n    send(data: string) {\r\n      socket.send(data);\r\n    },\r\n\r\n    onopen: null,\r\n    onmessage: null,\r\n    onclose: null,\r\n  } as ISocket & WS;\r\n}\r\n","// src/core/transport-browser.ts\r\nimport { ISocket } from \"./ISocket\";\r\n\r\nexport function createBrowserSocket(url: string): ISocket {\r\n  const socket = new WebSocket(url);\r\n\r\n  return socket as unknown as ISocket;\r\n}\r\n","// index.ts\r\n\r\nexport * from \"./core/SatoriClient\";\r\nexport * from \"./react/useSatori\";\r\nexport * from './schema';\r\n","// src/core/SatoriClient.ts\r\nimport { ISocket } from \"./ISocket\";\r\nimport { v4 as uuid } from \"uuid\";\r\n\r\nconst isBrowser = typeof window !== \"undefined\";\r\n\r\nexport class SatoriClient {\r\n  private ws: ISocket | null = null;\r\n  private url: string;\r\n  private token?: string;\r\n  private handlers = new Set<(msg: any) => void>();\r\n\r\n  connected = false;\r\n\r\n  constructor(options: { url: string; token?: string }) {\r\n    this.url = options.url;\r\n    this.token = options.token;\r\n  }\r\n\r\n  async connect() {\r\n    if (this.ws) return;\r\n\r\n    const { createNodeSocket } = await import(\"./transport-node.js\").catch(() => ({\r\n      createNodeSocket: null,\r\n    }));\r\n\r\n    const { createBrowserSocket } = await import(\"./transport-browser.js\").catch(() => ({\r\n      createBrowserSocket: null,\r\n    }));\r\n\r\n    const socketCreator = isBrowser ? createBrowserSocket : createNodeSocket;\r\n\r\n    if (!socketCreator) throw new Error(\"No WebSocket available.\");\r\n\r\n    const ws = socketCreator(this.url);\r\n    this.ws = ws;\r\n\r\n    return new Promise<void>((resolve) => {\r\n      ws.onopen = () => {\r\n        this.connected = true;\r\n        resolve();\r\n      };\r\n\r\n      ws.onmessage = (event) => {\r\n        let json;\r\n        try {\r\n          json = JSON.parse(event.data);\r\n        } catch {\r\n          return;\r\n        }\r\n        this.handlers.forEach((h) => h(json));\r\n      };\r\n\r\n      ws.onclose = () => {\r\n        this.connected = false;\r\n      };\r\n    });\r\n  }\r\n\r\n  onMessage(handler: any) {\r\n    this.handlers.add(handler);\r\n    return () => this.handlers.delete(handler);\r\n  }\r\n\r\n  send(op: string, payload: any) {\r\n    if (!this.ws || this.ws.readyState !== 1) {\r\n      throw new Error(\"WebSocket is not ready\");\r\n    }\r\n\r\n    const message = {\r\n      id: uuid(),\r\n      op,\r\n      payload,\r\n      token: this.token,\r\n    };\r\n\r\n    this.ws.send(JSON.stringify(message));\r\n    return message.id;\r\n  }\r\n\r\n  // API ----------\r\n\r\n  private request(op: string, payload: any) {\r\n    return new Promise((resolve) => {\r\n      const id = this.send(op, payload);\r\n      const off = this.onMessage((msg: any) => {\r\n        if (msg.id === id) {\r\n          off();\r\n          resolve(msg);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n  get(key: string) {\r\n    return this.request(\"GET\", { key });\r\n  }\r\n  set(key: string, value: any) {\r\n    return this.request(\"SET\", { key, value });\r\n  }\r\n  ask(prompt: string) {\r\n    return this.request(\"ASK\", { prompt });\r\n  }\r\n  query(prompt: string) {\r\n    return this.request(\"QUERY\", { prompt });\r\n  }\r\n  ann(vector: number[], top_k = 10) {\r\n    return this.request(\"ANN\", { vector, top_k });\r\n  }\r\n  train() {\r\n    return this.request(\"TRAIN\", {});\r\n  }\r\n  putAllWith(obj: any) {\r\n    return this.request(\"PUT_ALL_WITH\", obj);\r\n  }\r\n}\r\n","// src/react/useSatori.ts\r\nimport { useEffect, useRef, useState } from \"react\";\r\nimport { SatoriClient } from \"../core/SatoriClient\";\r\n\r\nexport function useSatori(options: { url: string; token?: string }) {\r\n  const clientRef = useRef<SatoriClient | null>(null);\r\n  const [connected, setConnected] = useState(false);\r\n  const [lastMessage, setLastMessage] = useState<any>(null);\r\n\r\n  if (!clientRef.current) {\r\n    clientRef.current = new SatoriClient(options);\r\n  }\r\n\r\n  const client = clientRef.current;\r\n\r\n  useEffect(() => {\r\n    let unsubscribe: any;\r\n\r\n    client.connect().then(() => {\r\n      setConnected(true);\r\n      unsubscribe = client.onMessage((msg: any) => {\r\n        setLastMessage(msg);\r\n      });\r\n    });\r\n\r\n    return () => {\r\n      unsubscribe?.();\r\n    };\r\n  }, []);\r\n\r\n  return {\r\n    connected,\r\n    lastMessage,\r\n\r\n    // API identical to original client\r\n    get: client.get.bind(client),\r\n    set: client.set.bind(client),\r\n    ask: client.ask.bind(client),\r\n    query: client.query.bind(client),\r\n    train: client.train.bind(client),\r\n    ann: client.ann.bind(client),\r\n    putAllWith: client.putAllWith.bind(client),\r\n  };\r\n}\r\n","import {Satori}from \"./satori\";\r\nimport { v4 as uuidv4 } from 'uuid';\r\n\r\nexport default class Schema<T extends object> {\r\n\r\n  satori!: Satori;\r\n  schemaName!: string;\r\n  body!: T;\r\n  key!: string;\r\n\r\n  constructor(body: T, satori: Satori, schemaName: string, key?: string) {\r\n    this.body = body;\r\n    this.satori = satori;\r\n\r\n    if (key) {\r\n      this.key = key;\r\n    }\r\n    this.key = uuidv4();\r\n    this.schemaName = schemaName;\r\n  }\r\n\r\n  async set(): Promise<string | boolean> {\r\n    return await this.satori.set({\r\n      key: this.key,\r\n      data: this.body,\r\n      type: this.schemaName,\r\n    });\r\n  }\r\n\r\n  async delete(): Promise<boolean> {\r\n    return await this.satori.delete({ key: this.key });\r\n  }\r\n\r\n  async encrypt(encryption_key: string): Promise<boolean> {\r\n    return await this.satori.encrypt({\r\n      key: this.key,\r\n      encryption_key: encryption_key,\r\n    });\r\n  }\r\n\r\n  async setVertex(vertex: string, relation: string, encryption_key?: string): Promise<boolean> {\r\n    return await this.satori.setVertex({\r\n      key: this.key,\r\n      vertex: vertex,\r\n      relation: relation,\r\n      encryption_key: encryption_key,\r\n    });\r\n  } //relation\r\n\r\n  async getVertex(encryption_key?: string): Promise<any | undefined> {\r\n    return await this.satori.getVertex({ key: this.key, encryption_key });\r\n  }\r\n\r\n  async deleteVertex(\r\n    vertex: string,\r\n    encryption_key?: string\r\n  ): Promise<Boolean> {\r\n    return this.satori.deleteVertex({\r\n      key: this.key,\r\n      encryption_key: encryption_key,\r\n      vertex: vertex,\r\n    });\r\n  }\r\n\r\n  async dfs(relation?: string, encryption_key?: string): Promise<any | undefined> {\r\n    return this.satori.dfs({ node: this.key, relation: relation, encryption_key });\r\n  }\r\n\r\n \r\n\r\n \r\n \r\n\r\n  async push(value: any, array: string, encryption_key?: string): Promise<Boolean> {\r\n    return await this.satori.push({key: this.key, value: value, array: array, encryption_key})\r\n  }\r\n\r\n  async pop(array: string, encryption_key?: string): Promise<Boolean> {\r\n    return await this.satori.pop({key: this.key, array: array, encryption_key})\r\n  }\r\n\r\n  async splice(array: string, encryption_key?: string): Promise<Boolean> {\r\n    return await this.satori.splice({key: this.key, array: array, encryption_key})\r\n  }\r\n\r\n  async remove(value: any, array: string, encryption_key?: string): Promise<Boolean> {\r\n    return await this.satori.remove({key: this.key, value: value, array: array, encryption_key})\r\n  }\r\n\r\n  async decrypt(encryption_key: string): Promise<Boolean> {\r\n    return await this.satori.decrypt({key: this.key, encryption_key: encryption_key})\r\n  }\r\n\r\n}\r\n"],"mappings":"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","names":["WS","createNodeSocket","createBrowserSocket","uuid","import_uuid"]}